# GitLab CI/CD Pipeline pour SIMVEB Portal (Nuxt 3)
# Author: DevOps Team
# Description: Pipeline complet pour build, test, et dÃ©ploiement du portail public

variables:
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE/portal

  # Node
  NODE_VERSION: "18"
  PNPM_VERSION: "latest"

  # Build args (Ã  dÃ©finir dans les variables CI/CD GitLab)
  VITE_API_URL: $VITE_API_URL
  VITE_CLIENT_ID: $VITE_CLIENT_ID
  VITE_CLIENT_SECRET: $VITE_CLIENT_SECRET
  VITE_FEDAPAY_PUBLIC_KEY: $VITE_FEDAPAY_PUBLIC_KEY
  VITE_SENTRY_DSN: $VITE_SENTRY_DSN

# DÃ©finition des stages
stages:
  - prepare
  - build
  - test
  - security
  - docker
  - deploy

# Cache pour optimiser les builds
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store/
    - node_modules/
    - .nuxt/
    - .output/

# Anchors pour rÃ©utilisation
.node_base:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

.docker_base:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin

# ===================================
# STAGE: PREPARE
# ===================================

pnpm:install:
  extends: .node_base
  stage: prepare
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags

# ===================================
# STAGE: BUILD
# ===================================

build:nuxt:
  extends: .node_base
  stage: build
  dependencies:
    - pnpm:install
  script:
    - echo "Building Nuxt 3 application..."
    - |
      VITE_API_URL=$VITE_API_URL \
      VITE_CLIENT_ID=$VITE_CLIENT_ID \
      VITE_CLIENT_SECRET=$VITE_CLIENT_SECRET \
      VITE_FEDAPAY_PUBLIC_KEY=$VITE_FEDAPAY_PUBLIC_KEY \
      VITE_SENTRY_DSN=$VITE_SENTRY_DSN \
      NODE_OPTIONS=--max-old-space-size=4096 \
      pnpm build
  artifacts:
    paths:
      - .output/
      - .nuxt/
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags

build:static:
  extends: .node_base
  stage: build
  dependencies:
    - pnpm:install
  script:
    - echo "Building static version for analysis..."
    - pnpm generate || echo "Static generation not configured"
  artifacts:
    paths:
      - .output/public/
      - dist/
    expire_in: 1 day
  allow_failure: true
  only:
    - branches
    - merge_requests

# ===================================
# STAGE: TEST
# ===================================

test:unit:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"test\"" package.json; then
        pnpm test
      else
        echo "No test script found, skipping..."
      fi
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  allow_failure: true
  only:
    - branches
    - merge_requests

test:e2e:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"test:e2e\"" package.json; then
        pnpm test:e2e
      else
        echo "No E2E test script found, skipping..."
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

lint:eslint:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"lint\"" package.json; then
        pnpm lint
      else
        echo "No lint script found, skipping..."
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

lint:prettier:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"format:check\"" package.json; then
        pnpm format:check
      elif [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ]; then
        npx prettier --check "**/*.{js,ts,vue,json,md}"
      else
        echo "Prettier not configured, skipping..."
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

typecheck:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"typecheck\"" package.json; then
        pnpm typecheck
      elif command -v nuxi &> /dev/null; then
        nuxi typecheck
      else
        echo "TypeScript check not available, skipping..."
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

# ===================================
# STAGE: SECURITY
# ===================================

security:audit:
  extends: .node_base
  stage: security
  dependencies:
    - pnpm:install
  script:
    - pnpm audit --prod || true
    - echo "Checking for known security vulnerabilities..."
  allow_failure: true
  only:
    - branches
    - merge_requests
    - tags

security:licenses:
  extends: .node_base
  stage: security
  dependencies:
    - pnpm:install
  script:
    - pnpm licenses list || echo "License check not configured"
  artifacts:
    paths:
      - licenses.txt
    expire_in: 30 days
  allow_failure: true
  only:
    - branches
    - tags

# ===================================
# STAGE: DOCKER
# ===================================

docker:build:
  extends: .docker_base
  stage: docker
  dependencies:
    - build:nuxt
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        TAG="latest"
      elif [[ "$CI_COMMIT_TAG" ]]; then
        TAG="$CI_COMMIT_TAG"
      else
        TAG="$CI_COMMIT_SHORT_SHA"
      fi
    - echo "Building Docker image with tag: $TAG"
    - |
      # CrÃ©er un Dockerfile si nÃ©cessaire
      if [ ! -f "Dockerfile" ]; then
        cat > Dockerfile <<'EOF'
      FROM node:18-alpine AS base
      WORKDIR /app

      RUN corepack enable && corepack prepare pnpm@latest --activate

      COPY package.json pnpm-lock.yaml ./
      COPY .npmrc ./ 2>/dev/null || echo "registry=https://registry.npmjs.org/" > .npmrc

      RUN pnpm install --frozen-lockfile --prod

      COPY . .

      ARG VITE_API_URL
      ARG VITE_CLIENT_ID
      ARG VITE_CLIENT_SECRET
      ARG VITE_FEDAPAY_PUBLIC_KEY
      ARG VITE_SENTRY_DSN

      RUN VITE_API_URL=$VITE_API_URL \
          VITE_CLIENT_ID=$VITE_CLIENT_ID \
          VITE_CLIENT_SECRET=$VITE_CLIENT_SECRET \
          VITE_FEDAPAY_PUBLIC_KEY=$VITE_FEDAPAY_PUBLIC_KEY \
          VITE_SENTRY_DSN=$VITE_SENTRY_DSN \
          NODE_OPTIONS=--max-old-space-size=4096 \
          pnpm build

      FROM node:18-alpine AS production
      WORKDIR /app

      RUN corepack enable && corepack prepare pnpm@latest --activate

      COPY --from=base /app/.output /app/.output
      COPY --from=base /app/package.json /app/

      EXPOSE 3000

      ENV HOST=0.0.0.0
      ENV PORT=3000

      CMD ["node", ".output/server/index.mjs"]
      EOF
      fi
    - |
      docker build \
        --build-arg VITE_API_URL=$VITE_API_URL \
        --build-arg VITE_CLIENT_ID=$VITE_CLIENT_ID \
        --build-arg VITE_CLIENT_SECRET=$VITE_CLIENT_SECRET \
        --build-arg VITE_FEDAPAY_PUBLIC_KEY=$VITE_FEDAPAY_PUBLIC_KEY \
        --build-arg VITE_SENTRY_DSN=$VITE_SENTRY_DSN \
        -t $DOCKER_IMAGE:$TAG \
        -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA \
        .
    - docker push $DOCKER_IMAGE:$TAG
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  only:
    - branches
    - tags
  except:
    - merge_requests

# ===================================
# STAGE: DEPLOY
# ===================================

.deploy_base:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts

deploy:development:
  extends: .deploy_base
  stage: deploy
  environment:
    name: development
    url: https://dev-portal.simveb-bj.com
  script:
    - echo "Deploying Portal to DEVELOPMENT environment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-portal && docker pull $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-portal && docker stop simveb-portal || true"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-portal && docker rm simveb-portal || true"
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-portal && docker run -d \
        --name simveb-portal \
        --restart unless-stopped \
        -p 8003:3000 \
        -e VITE_API_URL=$VITE_API_URL_DEV \
        $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA"
    - echo "âœ… Deployment to DEVELOPMENT completed successfully"
  only:
    - develop
    - /^feature\/.*$/
  when: manual

deploy:staging:
  extends: .deploy_base
  stage: deploy
  environment:
    name: staging
    url: https://staging-portal.simveb-bj.com
  script:
    - echo "Deploying Portal to STAGING environment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /var/www/simveb-portal && docker-compose pull"
    - ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /var/www/simveb-portal && docker-compose up -d"
    - echo "âœ… Deployment to STAGING completed successfully"
  only:
    - staging
    - /^release\/.*$/
  when: manual

deploy:production:
  extends: .deploy_base
  stage: deploy
  environment:
    name: production
    url: https://portal.simveb-bj.com
  script:
    - echo "ðŸ”’ Deploying Portal to PRODUCTION environment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /var/www/simveb-portal && docker-compose pull"
    - ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /var/www/simveb-portal && docker-compose up -d --no-deps portal"
    - echo "âœ… Deployment to PRODUCTION completed successfully"
  only:
    - main
    - master
    - tags
  when: manual
  needs:
    - docker:build
    - security:audit

# Health check aprÃ¨s dÃ©ploiement
healthcheck:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Running health check..."
    - sleep 30
    - curl -f https://portal.simveb-bj.com || exit 1
    - echo "âœ… Health check passed"
  only:
    - main
    - master
    - tags
  needs:
    - deploy:production
  when: on_success
