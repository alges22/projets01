version: '3.8'

# Docker Compose pour SIMVEB - Environnement PRODUCTION
# Ce fichier orchestre tous les services de l'application sur la VM App (Production)

services:
  # =========================================
  # BACKEND - Laravel API
  # =========================================
  backend:
    image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_TAG:-latest}
    container_name: simveb-backend-prod
    restart: always
    environment:
      - APP_NAME=SIMVEB
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=https://api.simveb-bj.com

      # Database
      - DB_CONNECTION=pgsql
      - DB_HOST=${DB_HOST}
      - DB_PORT=5432
      - DB_DATABASE=simveb_production
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}

      # Cache & Session
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_PORT=6379

      # Queue
      - QUEUE_CONNECTION=redis

      # OAuth Passport
      - PASSPORT_CLIENT_ID=${PASSPORT_CLIENT_ID}
      - PASSPORT_CLIENT_SECRET=${PASSPORT_CLIENT_SECRET}

      # Payment Gateways
      - FEDAPAY_PUBLIC_KEY=${FEDAPAY_PUBLIC_KEY}
      - FEDAPAY_SECRET_KEY=${FEDAPAY_SECRET_KEY}
      - FEDAPAY_ENVIRONMENT=live
      - KKIAPAY_PRIVATE_KEY=${KKIAPAY_PRIVATE_KEY}
      - KKIAPAY_PUBLIC_KEY=${KKIAPAY_PUBLIC_KEY}
      - KKIAPAY_SECRET=${KKIAPAY_SECRET}
      - KKIAPAY_SANDBOX=false

      # Monitoring
      - SENTRY_LARAVEL_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=production

    volumes:
      - backend-storage:/var/www/html/storage
      - backend-logs:/var/www/html/storage/logs
    networks:
      - simveb-network
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD", "php", "artisan", "health:check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-prod.rule=Host(`api.simveb-bj.com`)"
      - "traefik.http.routers.backend-prod.entrypoints=websecure"
      - "traefik.http.routers.backend-prod.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend-prod.loadbalancer.server.port=9000"

  # =========================================
  # NGINX - Web Server for Backend
  # =========================================
  nginx:
    image: ${CI_REGISTRY_IMAGE}/backend-nginx:${CI_COMMIT_TAG:-latest}
    container_name: simveb-nginx-prod
    restart: always
    ports:
      - "8080:80"
    volumes:
      - backend-storage:/var/www/html/storage:ro
    networks:
      - simveb-network
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nginx-prod.rule=Host(`api.simveb-bj.com`)"
      - "traefik.http.routers.nginx-prod.entrypoints=websecure"
      - "traefik.http.routers.nginx-prod.tls.certresolver=letsencrypt"

  # =========================================
  # PORTAL - Nuxt.js Frontend
  # =========================================
  portal:
    image: ${CI_REGISTRY_IMAGE}/portal:${CI_COMMIT_TAG:-latest}
    container_name: simveb-portal-prod
    restart: always
    environment:
      - NUXT_PUBLIC_API_URL=https://api.simveb-bj.com
      - NUXT_PUBLIC_CLIENT_ID=${PORTAL_CLIENT_ID}
      - NUXT_PUBLIC_CLIENT_SECRET=${PORTAL_CLIENT_SECRET}
      - NUXT_PUBLIC_FEDAPAY_PUBLIC_KEY=${FEDAPAY_PUBLIC_KEY}
      - NUXT_PUBLIC_SENTRY_DSN=${PORTAL_SENTRY_DSN}
      - NUXT_PUBLIC_ENVIRONMENT=production
    ports:
      - "3000:3000"
    networks:
      - simveb-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal-prod.rule=Host(`simveb-bj.com`) || Host(`www.simveb-bj.com`)"
      - "traefik.http.routers.portal-prod.entrypoints=websecure"
      - "traefik.http.routers.portal-prod.tls.certresolver=letsencrypt"
      - "traefik.http.services.portal-prod.loadbalancer.server.port=3000"

  # =========================================
  # BACKOFFICE - Vue.js Admin Panel
  # =========================================
  backoffice:
    image: ${CI_REGISTRY_IMAGE}/backoffice:${CI_COMMIT_TAG:-latest}
    container_name: simveb-backoffice-prod
    restart: always
    environment:
      - VITE_API_URL=https://api.simveb-bj.com
      - VITE_CLIENT_ID=${BACKOFFICE_CLIENT_ID}
      - VITE_CLIENT_SECRET=${BACKOFFICE_CLIENT_SECRET}
      - VITE_MAPBOX_ACCESS_TOKEN=${MAPBOX_ACCESS_TOKEN}
      - VITE_SENTRY_DSN=${BACKOFFICE_SENTRY_DSN}
      - VITE_ENVIRONMENT=production
    ports:
      - "3001:80"
    networks:
      - simveb-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backoffice-prod.rule=Host(`admin.simveb-bj.com`)"
      - "traefik.http.routers.backoffice-prod.entrypoints=websecure"
      - "traefik.http.routers.backoffice-prod.tls.certresolver=letsencrypt"

  # =========================================
  # AFFILIATE - Vue.js Affiliate Portal
  # =========================================
  affiliate:
    image: ${CI_REGISTRY_IMAGE}/affiliate:${CI_COMMIT_TAG:-latest}
    container_name: simveb-affiliate-prod
    restart: always
    environment:
      - VITE_API_URL=https://api.simveb-bj.com
      - VITE_CLIENT_ID=${AFFILIATE_CLIENT_ID}
      - VITE_CLIENT_SECRET=${AFFILIATE_CLIENT_SECRET}
      - VITE_SENTRY_DSN=${AFFILIATE_SENTRY_DSN}
      - VITE_ENVIRONMENT=production
    ports:
      - "3002:80"
    networks:
      - simveb-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.affiliate-prod.rule=Host(`affiliate.simveb-bj.com`)"
      - "traefik.http.routers.affiliate-prod.entrypoints=websecure"
      - "traefik.http.routers.affiliate-prod.tls.certresolver=letsencrypt"

  # =========================================
  # REDIS - Cache & Queue
  # =========================================
  redis:
    image: redis:7-alpine
    container_name: simveb-redis-prod
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - simveb-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # =========================================
  # QUEUE WORKER - Laravel Queue (Multiple Workers)
  # =========================================
  queue-worker-1:
    image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_TAG:-latest}
    container_name: simveb-queue-prod-1
    restart: always
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    environment:
      - APP_ENV=production
      - DB_HOST=${DB_HOST}
      - DB_DATABASE=simveb_production
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - QUEUE_CONNECTION=redis
    volumes:
      - backend-storage:/var/www/html/storage
      - backend-logs:/var/www/html/storage/logs
    networks:
      - simveb-network
    depends_on:
      - redis
      - backend

  queue-worker-2:
    image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_TAG:-latest}
    container_name: simveb-queue-prod-2
    restart: always
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    environment:
      - APP_ENV=production
      - DB_HOST=${DB_HOST}
      - DB_DATABASE=simveb_production
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - QUEUE_CONNECTION=redis
    volumes:
      - backend-storage:/var/www/html/storage
      - backend-logs:/var/www/html/storage/logs
    networks:
      - simveb-network
    depends_on:
      - redis
      - backend

  # =========================================
  # SCHEDULER - Laravel Cron
  # =========================================
  scheduler:
    image: ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_TAG:-latest}
    container_name: simveb-scheduler-prod
    restart: always
    command: bash -c "while true; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
    environment:
      - APP_ENV=production
      - DB_HOST=${DB_HOST}
      - DB_DATABASE=simveb_production
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - backend-storage:/var/www/html/storage
      - backend-logs:/var/www/html/storage/logs
    networks:
      - simveb-network
    depends_on:
      - redis
      - backend

volumes:
  backend-storage:
    driver: local
  backend-logs:
    driver: local
  redis-data:
    driver: local

networks:
  simveb-network:
    driver: bridge
