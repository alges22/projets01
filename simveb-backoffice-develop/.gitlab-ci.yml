# GitLab CI/CD Pipeline pour SIMVEB Backoffice (Vue 3)
# Author: DevOps Team
# Description: Pipeline complet pour build, test, et dÃ©ploiement du backoffice

variables:
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE/backoffice

  # Node
  NODE_VERSION: "18"
  PNPM_VERSION: "latest"

  # Build args (Ã  dÃ©finir dans les variables CI/CD GitLab)
  VITE_API_URL: $VITE_API_URL
  VITE_CLIENT_ID: $VITE_CLIENT_ID
  VITE_CLIENT_SECRET: $VITE_CLIENT_SECRET
  VITE_MAPBOX_ACCESS_TOKEN: $VITE_MAPBOX_ACCESS_TOKEN
  VITE_SENTRY_DSN: $VITE_SENTRY_DSN
  GTM_ID: $GTM_ID

# DÃ©finition des stages
stages:
  - prepare
  - build
  - test
  - security
  - docker
  - deploy

# Cache pour optimiser les builds
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store/
    - node_modules/
    - dist/

# Anchors pour rÃ©utilisation
.node_base:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

.docker_base:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin

# ===================================
# STAGE: PREPARE
# ===================================

pnpm:install:
  extends: .node_base
  stage: prepare
  script:
    - echo "Installing dependencies with pnpm..."
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags

# ===================================
# STAGE: BUILD
# ===================================

build:vite:
  extends: .node_base
  stage: build
  dependencies:
    - pnpm:install
  script:
    - echo "Building Vue 3 application with Vite..."
    - |
      VITE_API_URL=$VITE_API_URL \
      VITE_CLIENT_ID=$VITE_CLIENT_ID \
      VITE_CLIENT_SECRET=$VITE_CLIENT_SECRET \
      VITE_MAPBOX_ACCESS_TOKEN=$VITE_MAPBOX_ACCESS_TOKEN \
      VITE_SENTRY_DSN=$VITE_SENTRY_DSN \
      GTM_ID=$GTM_ID \
      NODE_OPTIONS=--max-old-space-size=4096 \
      pnpm build
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags

build:ssr:
  extends: .node_base
  stage: build
  dependencies:
    - pnpm:install
  script:
    - echo "Building SSR version if available..."
    - |
      if grep -q "\"ssr:build\"" package.json; then
        VITE_API_URL=$VITE_API_URL \
        VITE_CLIENT_ID=$VITE_CLIENT_ID \
        VITE_CLIENT_SECRET=$VITE_CLIENT_SECRET \
        VITE_MAPBOX_ACCESS_TOKEN=$VITE_MAPBOX_ACCESS_TOKEN \
        VITE_SENTRY_DSN=$VITE_SENTRY_DSN \
        GTM_ID=$GTM_ID \
        NODE_OPTIONS=--max-old-space-size=4096 \
        pnpm ssr:build
      else
        echo "SSR build not configured, skipping..."
      fi
  artifacts:
    paths:
      - dist/
      - .output/
    expire_in: 1 day
  allow_failure: true
  only:
    - branches
    - tags

# ===================================
# STAGE: TEST
# ===================================

test:unit:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"test\"" package.json; then
        pnpm test
      elif grep -q "\"test:unit\"" package.json; then
        pnpm test:unit
      else
        echo "No test script found, skipping..."
      fi
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  allow_failure: true
  only:
    - branches
    - merge_requests

lint:eslint:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"lint\"" package.json; then
        pnpm lint
      else
        echo "No lint script found, running default eslint..."
        npx eslint "src/**/*.{js,ts,vue}" || echo "ESLint not configured"
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

lint:prettier:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"format:check\"" package.json; then
        pnpm format:check
      elif [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ]; then
        npx prettier --check "src/**/*.{js,ts,vue,json,css,scss}"
      else
        echo "Prettier not configured, skipping..."
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

typecheck:
  extends: .node_base
  stage: test
  dependencies:
    - pnpm:install
  script:
    - |
      if grep -q "\"typecheck\"" package.json; then
        pnpm typecheck
      elif [ -f "tsconfig.json" ]; then
        npx vue-tsc --noEmit || echo "TypeScript check failed"
      else
        echo "TypeScript not configured, skipping..."
      fi
  allow_failure: true
  only:
    - branches
    - merge_requests

# ===================================
# STAGE: SECURITY
# ===================================

security:audit:
  extends: .node_base
  stage: security
  dependencies:
    - pnpm:install
  script:
    - pnpm audit --prod || true
    - echo "Checking for known security vulnerabilities..."
  allow_failure: true
  only:
    - branches
    - merge_requests
    - tags

security:dependency-check:
  extends: .node_base
  stage: security
  dependencies:
    - pnpm:install
  script:
    - echo "Checking for outdated dependencies..."
    - pnpm outdated || true
  allow_failure: true
  only:
    - branches
    - tags

# ===================================
# STAGE: DOCKER
# ===================================

docker:build:
  extends: .docker_base
  stage: docker
  dependencies:
    - build:vite
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        TAG="latest"
      elif [[ "$CI_COMMIT_TAG" ]]; then
        TAG="$CI_COMMIT_TAG"
      else
        TAG="$CI_COMMIT_SHORT_SHA"
      fi
    - echo "Building Docker image with tag: $TAG"
    - |
      # Utiliser le Dockerfile existant
      docker build \
        --build-arg VITE_API_URL=$VITE_API_URL \
        --build-arg VITE_CLIENT_ID=$VITE_CLIENT_ID \
        --build-arg VITE_CLIENT_SECRET=$VITE_CLIENT_SECRET \
        --build-arg VITE_MAPBOX_ACCESS_TOKEN=$VITE_MAPBOX_ACCESS_TOKEN \
        --build-arg VITE_SENTRY_DSN=$VITE_SENTRY_DSN \
        --build-arg GTM_ID=$GTM_ID \
        -t $DOCKER_IMAGE:$TAG \
        -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA \
        -f Dockerfile \
        .
    - docker push $DOCKER_IMAGE:$TAG
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  only:
    - branches
    - tags
  except:
    - merge_requests

docker:build:nginx:
  extends: .docker_base
  stage: docker
  dependencies:
    - build:vite
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        TAG="latest"
      else
        TAG="$CI_COMMIT_SHORT_SHA"
      fi
    - echo "Building Nginx static image with tag: $TAG"
    - |
      cat > Dockerfile.nginx <<'EOF'
      FROM nginx:1.24-alpine

      # Copier les fichiers buildÃ©s
      COPY dist/ /usr/share/nginx/html/

      # Configuration Nginx pour SPA
      RUN echo 'server { \
          listen 80; \
          server_name _; \
          root /usr/share/nginx/html; \
          index index.html; \
          location / { \
              try_files $uri $uri/ /index.html; \
          } \
          location /api { \
              proxy_pass $VITE_API_URL; \
              proxy_http_version 1.1; \
              proxy_set_header Upgrade $http_upgrade; \
              proxy_set_header Connection "upgrade"; \
              proxy_set_header Host $host; \
              proxy_cache_bypass $http_upgrade; \
          } \
          gzip on; \
          gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript; \
      }' > /etc/nginx/conf.d/default.conf

      EXPOSE 80
      CMD ["nginx", "-g", "daemon off;"]
      EOF
    - docker build -f Dockerfile.nginx -t $DOCKER_IMAGE-nginx:$TAG .
    - docker push $DOCKER_IMAGE-nginx:$TAG
  only:
    - branches
    - tags
  except:
    - merge_requests

# ===================================
# STAGE: DEPLOY
# ===================================

.deploy_base:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts

deploy:development:
  extends: .deploy_base
  stage: deploy
  environment:
    name: development
    url: https://dev-admin.simveb-bj.com
  script:
    - echo "Deploying Backoffice to DEVELOPMENT environment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-backoffice && docker pull $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-backoffice && docker stop simveb-backoffice || true"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-backoffice && docker rm simveb-backoffice || true"
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/simveb-backoffice && docker run -d \
        --name simveb-backoffice \
        --restart unless-stopped \
        -p 3000:3000 \
        $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA"
    - echo "âœ… Deployment to DEVELOPMENT completed successfully"
  only:
    - develop
    - /^feature\/.*$/
  when: manual

deploy:staging:
  extends: .deploy_base
  stage: deploy
  environment:
    name: staging
    url: https://staging-admin.simveb-bj.com
  script:
    - echo "Deploying Backoffice to STAGING environment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /var/www/simveb-backoffice && docker-compose pull"
    - ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /var/www/simveb-backoffice && docker-compose up -d"
    - echo "âœ… Deployment to STAGING completed successfully"
  only:
    - staging
    - /^release\/.*$/
  when: manual

deploy:production:
  extends: .deploy_base
  stage: deploy
  environment:
    name: production
    url: https://admin.simveb-bj.com
  script:
    - echo "ðŸ”’ Deploying Backoffice to PRODUCTION environment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /var/www/simveb-backoffice && docker-compose pull"
    - ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /var/www/simveb-backoffice && docker-compose up -d --no-deps backoffice"
    - echo "âœ… Deployment to PRODUCTION completed successfully"
  only:
    - main
    - master
    - tags
  when: manual
  needs:
    - docker:build
    - security:audit

# Health check aprÃ¨s dÃ©ploiement
healthcheck:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Running health check..."
    - sleep 30
    - curl -f https://admin.simveb-bj.com || exit 1
    - echo "âœ… Health check passed"
  only:
    - main
    - master
    - tags
  needs:
    - deploy:production
  when: on_success
