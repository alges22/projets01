# GitLab CI/CD Pipeline Principal - SIMVEB
# Author: DevOps Team
# Description: Pipeline orchestrateur pour l'ensemble du projet SIMVEB

# Ce pipeline d√©tecte les changements dans les diff√©rents composants
# et d√©clenche les pipelines appropri√©s

variables:
  # Docker Registry
  CI_REGISTRY: registry.gitlab.com
  DOCKER_DRIVER: overlay2

# D√©finition des stages
stages:
  - detect-changes
  - trigger-builds
  - integration-tests
  - deploy-all
  - notify

# ===================================
# STAGE: DETECT CHANGES
# D√©tecte quels composants ont chang√©
# ===================================

detect:backend:
  stage: detect-changes
  image: alpine:latest
  script:
    - echo "Checking for changes in Backend..."
    - |
      if [ -n "$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA -- simveb-backend-develop/)" ]; then
        echo "BACKEND_CHANGED=true" > backend.env
        echo "‚úÖ Backend has changes"
      else
        echo "BACKEND_CHANGED=false" > backend.env
        echo "‚ÑπÔ∏è No changes in Backend"
      fi
  artifacts:
    reports:
      dotenv: backend.env
    expire_in: 1 hour
  only:
    - branches
    - merge_requests

detect:portal:
  stage: detect-changes
  image: alpine:latest
  script:
    - echo "Checking for changes in Portal..."
    - |
      if [ -n "$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA -- simveb-portal-design-develop/)" ]; then
        echo "PORTAL_CHANGED=true" > portal.env
        echo "‚úÖ Portal has changes"
      else
        echo "PORTAL_CHANGED=false" > portal.env
        echo "‚ÑπÔ∏è No changes in Portal"
      fi
  artifacts:
    reports:
      dotenv: portal.env
    expire_in: 1 hour
  only:
    - branches
    - merge_requests

detect:backoffice:
  stage: detect-changes
  image: alpine:latest
  script:
    - echo "Checking for changes in Backoffice..."
    - |
      if [ -n "$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA -- simveb-backoffice-develop/)" ]; then
        echo "BACKOFFICE_CHANGED=true" > backoffice.env
        echo "‚úÖ Backoffice has changes"
      else
        echo "BACKOFFICE_CHANGED=false" > backoffice.env
        echo "‚ÑπÔ∏è No changes in Backoffice"
      fi
  artifacts:
    reports:
      dotenv: backoffice.env
    expire_in: 1 hour
  only:
    - branches
    - merge_requests

detect:affiliate:
  stage: detect-changes
  image: alpine:latest
  script:
    - echo "Checking for changes in Affiliate..."
    - |
      if [ -n "$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA -- simveb-affiliate-develop/)" ]; then
        echo "AFFILIATE_CHANGED=true" > affiliate.env
        echo "‚úÖ Affiliate has changes"
      else
        echo "AFFILIATE_CHANGED=false" > affiliate.env
        echo "‚ÑπÔ∏è No changes in Affiliate"
      fi
  artifacts:
    reports:
      dotenv: affiliate.env
    expire_in: 1 hour
  only:
    - branches
    - merge_requests

# ===================================
# STAGE: TRIGGER BUILDS
# D√©clenche les builds des composants
# ===================================

trigger:backend:
  stage: trigger-builds
  trigger:
    include:
      - local: simveb-backend-develop/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '$BACKEND_CHANGED == "true"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  needs:
    - detect:backend

trigger:portal:
  stage: trigger-builds
  trigger:
    include:
      - local: simveb-portal-design-develop/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '$PORTAL_CHANGED == "true"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  needs:
    - detect:portal

trigger:backoffice:
  stage: trigger-builds
  trigger:
    include:
      - local: simveb-backoffice-develop/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '$BACKOFFICE_CHANGED == "true"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  needs:
    - detect:backoffice

trigger:affiliate:
  stage: trigger-builds
  trigger:
    include:
      - local: simveb-affiliate-develop/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '$AFFILIATE_CHANGED == "true"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  needs:
    - detect:affiliate

# ===================================
# STAGE: INTEGRATION TESTS
# Tests d'int√©gration entre composants
# ===================================

integration:api-tests:
  stage: integration-tests
  image: node:18-alpine
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: simveb_test
    POSTGRES_USER: simveb
    POSTGRES_PASSWORD: secret
  script:
    - echo "Running integration tests..."
    - |
      if [ -f "tests/integration/package.json" ]; then
        cd tests/integration
        npm install
        npm run test:integration
      else
        echo "No integration tests configured"
      fi
  allow_failure: true
  only:
    - merge_requests
    - main
    - master

integration:e2e-tests:
  stage: integration-tests
  image: cypress/browsers:node18.12.0-chrome107
  script:
    - echo "Running E2E tests..."
    - |
      if [ -f "tests/e2e/package.json" ]; then
        cd tests/e2e
        npm install
        npm run test:e2e:ci
      else
        echo "No E2E tests configured"
      fi
  artifacts:
    when: always
    paths:
      - tests/e2e/cypress/videos/
      - tests/e2e/cypress/screenshots/
    expire_in: 7 days
  allow_failure: true
  only:
    - merge_requests
    - main
    - master

# ===================================
# STAGE: DEPLOY ALL
# D√©ploiement coordonn√© de tous les composants
# ===================================

# Job de d√©ploiement STAGING (automatique sur branche staging)
deploy:staging:
  stage: deploy-all
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash rsync curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST_STAGING >> ~/.ssh/known_hosts
  script:
    - echo "üöÄ Deploying SIMVEB to STAGING environment..."
    - echo "Target: $DEPLOY_HOST_STAGING"

    # Sync deployment files to server
    - rsync -avz --delete deploy/ $DEPLOY_USER@$DEPLOY_HOST_STAGING:/opt/simveb/deploy/
    - rsync -avz --delete simvebbase\ \(1\).sql $DEPLOY_USER@$DEPLOY_HOST_STAGING:/opt/simveb/ || true

    # Create .env.staging file on server
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cat > /opt/simveb/.env.staging << 'EOF'
      CI_REGISTRY=$CI_REGISTRY
      CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE
      CI_REGISTRY_USER=$CI_DEPLOY_USER
      CI_REGISTRY_PASSWORD=$CI_DEPLOY_PASSWORD
      CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA

      DB_HOST=$DB_HOST_STAGING
      DB_USERNAME=$DB_USERNAME_STAGING
      DB_PASSWORD=$DB_PASSWORD_STAGING

      REDIS_PASSWORD=$REDIS_PASSWORD_STAGING

      PASSPORT_CLIENT_ID=$PASSPORT_CLIENT_ID_STAGING
      PASSPORT_CLIENT_SECRET=$PASSPORT_CLIENT_SECRET_STAGING

      FEDAPAY_PUBLIC_KEY=$FEDAPAY_PUBLIC_KEY_SANDBOX
      FEDAPAY_SECRET_KEY=$FEDAPAY_SECRET_KEY_SANDBOX

      KKIAPAY_PRIVATE_KEY=$KKIAPAY_PRIVATE_KEY_SANDBOX
      KKIAPAY_PUBLIC_KEY=$KKIAPAY_PUBLIC_KEY_SANDBOX
      KKIAPAY_SECRET=$KKIAPAY_SECRET_SANDBOX

      SENTRY_DSN=$SENTRY_DSN_STAGING

      PORTAL_CLIENT_ID=$PORTAL_CLIENT_ID_STAGING
      PORTAL_CLIENT_SECRET=$PORTAL_CLIENT_SECRET_STAGING
      PORTAL_SENTRY_DSN=$PORTAL_SENTRY_DSN_STAGING

      BACKOFFICE_CLIENT_ID=$BACKOFFICE_CLIENT_ID_STAGING
      BACKOFFICE_CLIENT_SECRET=$BACKOFFICE_CLIENT_SECRET_STAGING
      BACKOFFICE_SENTRY_DSN=$BACKOFFICE_SENTRY_DSN_STAGING
      MAPBOX_ACCESS_TOKEN=$MAPBOX_ACCESS_TOKEN

      AFFILIATE_CLIENT_ID=$AFFILIATE_CLIENT_ID_STAGING
      AFFILIATE_CLIENT_SECRET=$AFFILIATE_CLIENT_SECRET_STAGING
      AFFILIATE_SENTRY_DSN=$AFFILIATE_SENTRY_DSN_STAGING
      EOF
      "

    # Execute deployment script
    - ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /opt/simveb && bash deploy/staging/deploy-all.sh"

    # Health check
    - sleep 30
    - curl -f http://$DEPLOY_HOST_STAGING:8080/health || echo "Warning: Backend health check failed"

    - echo "‚úÖ Staging deployment completed!"
  environment:
    name: staging
    url: https://staging.simveb-bj.com
    on_stop: stop:staging
  only:
    - staging
  when: on_success

# Job d'arr√™t de staging
stop:staging:
  stage: deploy-all
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST_STAGING >> ~/.ssh/known_hosts
  script:
    - ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /opt/simveb && docker-compose -f deploy/staging/docker-compose.yml down"
  environment:
    name: staging
    action: stop
  only:
    - staging
  when: manual

# Job de d√©ploiement PRODUCTION (manuel sur branche main)
deploy:production:
  stage: deploy-all
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash rsync curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST_PROD >> ~/.ssh/known_hosts
  script:
    - echo "üîí Deploying SIMVEB to PRODUCTION environment..."
    - echo "‚ö†Ô∏è This is a PRODUCTION deployment!"
    - echo "Target: $DEPLOY_HOST_PROD"

    # Sync deployment files to server
    - rsync -avz --delete deploy/ $DEPLOY_USER@$DEPLOY_HOST_PROD:/opt/simveb/deploy/
    - rsync -avz --delete simvebbase\ \(1\).sql $DEPLOY_USER@$DEPLOY_HOST_PROD:/opt/simveb/ || true

    # Create .env.production file on server
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cat > /opt/simveb/.env.production << 'EOF'
      CI_REGISTRY=$CI_REGISTRY
      CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE
      CI_REGISTRY_USER=$CI_DEPLOY_USER
      CI_REGISTRY_PASSWORD=$CI_DEPLOY_PASSWORD
      CI_COMMIT_TAG=${CI_COMMIT_TAG:-latest}

      DB_HOST=$DB_HOST_PROD
      DB_USERNAME=$DB_USERNAME_PROD
      DB_PASSWORD=$DB_PASSWORD_PROD

      REDIS_PASSWORD=$REDIS_PASSWORD_PROD

      PASSPORT_CLIENT_ID=$PASSPORT_CLIENT_ID_PROD
      PASSPORT_CLIENT_SECRET=$PASSPORT_CLIENT_SECRET_PROD

      FEDAPAY_PUBLIC_KEY=$FEDAPAY_PUBLIC_KEY_LIVE
      FEDAPAY_SECRET_KEY=$FEDAPAY_SECRET_KEY_LIVE

      KKIAPAY_PRIVATE_KEY=$KKIAPAY_PRIVATE_KEY_LIVE
      KKIAPAY_PUBLIC_KEY=$KKIAPAY_PUBLIC_KEY_LIVE
      KKIAPAY_SECRET=$KKIAPAY_SECRET_LIVE

      SENTRY_DSN=$SENTRY_DSN_PROD

      PORTAL_CLIENT_ID=$PORTAL_CLIENT_ID_PROD
      PORTAL_CLIENT_SECRET=$PORTAL_CLIENT_SECRET_PROD
      PORTAL_SENTRY_DSN=$PORTAL_SENTRY_DSN_PROD

      BACKOFFICE_CLIENT_ID=$BACKOFFICE_CLIENT_ID_PROD
      BACKOFFICE_CLIENT_SECRET=$BACKOFFICE_CLIENT_SECRET_PROD
      BACKOFFICE_SENTRY_DSN=$BACKOFFICE_SENTRY_DSN_PROD
      MAPBOX_ACCESS_TOKEN=$MAPBOX_ACCESS_TOKEN

      AFFILIATE_CLIENT_ID=$AFFILIATE_CLIENT_ID_PROD
      AFFILIATE_CLIENT_SECRET=$AFFILIATE_CLIENT_SECRET_PROD
      AFFILIATE_SENTRY_DSN=$AFFILIATE_SENTRY_DSN_PROD

      SLACK_WEBHOOK_URL=$SLACK_WEBHOOK_URL
      EOF
      "

    # Execute deployment script
    - ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /opt/simveb && bash deploy/production/deploy-all.sh"

    # Health check
    - sleep 60
    - curl -f http://$DEPLOY_HOST_PROD:8080/health || (echo "ERROR: Production health check failed!" && exit 1)

    - echo "‚úÖ Production deployment completed successfully!"
  environment:
    name: production
    url: https://simveb-bj.com
  only:
    - main
    - master
    - tags
  when: manual

# Rollback PRODUCTION
rollback:production:
  stage: deploy-all
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST_PROD >> ~/.ssh/known_hosts
  script:
    - echo "üîÑ Rolling back PRODUCTION deployment..."
    - ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /opt/simveb && bash deploy/production/deploy-all.sh rollback"
    - echo "‚úÖ Rollback completed"
  environment:
    name: production
    action: rollback
  only:
    - main
    - master
  when: manual

# ===================================
# STAGE: NOTIFY
# Notifications apr√®s d√©ploiement
# ===================================

notify:slack:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        COMMIT_MESSAGE=$(git log -1 --pretty=%B)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)

        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"‚úÖ SIMVEB Deployment Completed\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"‚úÖ Deployment Successful\"
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Project:*\nSIMVEB\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\n$CI_COMMIT_REF_NAME\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\n$CI_COMMIT_SHORT_SHA\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Author:*\n$COMMIT_AUTHOR\"}
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit Message:*\n$COMMIT_MESSAGE\"
                }
              },
              {
                \"type\": \"actions\",
                \"elements\": [
                  {
                    \"type\": \"button\",
                    \"text\": {\"type\": \"plain_text\", \"text\": \"View Pipeline\"},
                    \"url\": \"$CI_PIPELINE_URL\"
                  }
                ]
              }
            ]
          }"
        echo "‚úÖ Slack notification sent"
      else
        echo "‚ÑπÔ∏è SLACK_WEBHOOK_URL not configured"
      fi
  allow_failure: true
  only:
    - main
    - master
    - staging
  when: on_success

notify:email:
  stage: notify
  image: alpine:latest
  script:
    - echo "üìß Email notification would be sent here"
    - echo "Environment: $CI_ENVIRONMENT_NAME"
    - echo "Status: Success"
    - echo "Pipeline URL: $CI_PIPELINE_URL"
  allow_failure: true
  only:
    - main
    - master
  when: on_success

# ===================================
# SCHEDULE JOBS (Nightly builds, etc.)
# ===================================

# Pour activer: GitLab > CI/CD > Schedules
# Cr√©er un schedule avec la variable SCHEDULED_JOB=nightly

nightly:full-build:
  stage: trigger-builds
  script:
    - echo "üåô Running nightly full build of all components"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_JOB == "nightly"'
  trigger:
    include:
      - local: simveb-backend-develop/.gitlab-ci.yml
      - local: simveb-portal-design-develop/.gitlab-ci.yml
      - local: simveb-backoffice-develop/.gitlab-ci.yml
      - local: simveb-affiliate-develop/.gitlab-ci.yml

security:weekly-scan:
  stage: integration-tests
  image: alpine:latest
  script:
    - echo "üîí Running weekly security scan"
    - echo "This would run comprehensive security checks across all components"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_JOB == "security"'
  allow_failure: true

# ===================================
# MANUAL JOBS
# ===================================

rollback:production:
  stage: deploy-all
  image: alpine:latest
  script:
    - echo "üîÑ Rolling back PRODUCTION deployment"
    - echo "This will trigger rollback for all components"
  environment:
    name: production-all
    action: rollback
  only:
    - main
    - master
  when: manual

# Database backup is now handled automatically in deployment scripts
# Manual backup job for emergency use
database:manual-backup:
  stage: deploy-all
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "üíæ Creating manual database backup..."
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "master" ]; then
        ssh-keyscan -H $DEPLOY_HOST_PROD >> ~/.ssh/known_hosts
        ssh $DEPLOY_USER@$DEPLOY_HOST_PROD "cd /opt/simveb && bash deploy/database/backup-db.sh production"
      else
        ssh-keyscan -H $DEPLOY_HOST_STAGING >> ~/.ssh/known_hosts
        ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING "cd /opt/simveb && bash deploy/database/backup-db.sh staging"
      fi
    - echo "‚úÖ Manual backup completed"
  only:
    - main
    - master
    - staging
  when: manual

# ===================================
# INCLUDE: Workflows et r√®gles
# ===================================

workflow:
  rules:
    # Ne pas ex√©cuter pour les commits draft
    - if: $CI_COMMIT_TITLE =~ /^DRAFT/
      when: never
    # Ne pas ex√©cuter pour les commits WIP
    - if: $CI_COMMIT_TITLE =~ /^WIP/
      when: never
    # Ex√©cuter pour les branches
    - if: $CI_COMMIT_BRANCH
    # Ex√©cuter pour les merge requests
    - if: $CI_MERGE_REQUEST_ID
    # Ex√©cuter pour les tags
    - if: $CI_COMMIT_TAG
    # Ex√©cuter pour les schedules
    - if: $CI_PIPELINE_SOURCE == "schedule"
